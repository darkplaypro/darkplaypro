<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Conexión FA Plus</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 20px; }
        .search-area { text-align: center; margin-bottom: 30px; }
        input { padding: 15px; width: 80%; border-radius: 25px; border: none; font-size: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .movie-card { background: #111; border-radius: 10px; overflow: hidden; cursor: pointer; border: 1px solid #333; }
        .movie-card img { width: 100%; height: 210px; object-fit: cover; }
        .movie-card h3 { font-size: 12px; padding: 10px; margin: 0; text-align: center; }
        
        /* Capa de Reproducción */
        #player-box { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; z-index: 100; }
        video { width: 100%; height: 60vh; background: #000; }
        .controls { padding: 20px; text-align: center; }
        .btn-test { background: #2ecc71; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; margin: 5px; }
        .back-btn { background: #e74c3c; color: white; border: none; padding: 10px; width: 100%; }
    </style>
</head>
<body>

<div class="search-area">
    <h2>PROBADOR DE BASE DE DATOS FA PLUS</h2>
    <input type="text" id="query" placeholder="Busca una peli (ej: La hora de los valientes)" onkeyup="buscarTMDB()">
</div>

<div id="resultados" class="grid"></div>

<div id="player-box">
    <button class="back-btn" onclick="cerrarPlayer()">✖ CERRAR Y VOLVER AL BUSCADOR</button>
    <video id="video-tester" controls></video>
    <div class="controls">
        <h2 id="test-title"></h2>
        <p id="test-status" style="color: #2ecc71;">Estado: Esperando Servidor...</p>
        <button class="btn-test" onclick="conectarFAPlus('Ultra')">PROBAR SERVIDOR ULTRA</button>
        <button class="btn-test" onclick="conectarFAPlus('Pegasus')">PROBAR SERVIDOR PEGASUS</button>
    </div>
</div>

<script>
    const KEY = 'bed364d1c4540454436cefd9d8a1c574';
    let peliSeleccionada = null;

    async function buscarTMDB() {
        const q = document.getElementById('query').value;
        if(q.length < 3) return;
        const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${KEY}&language=es-MX&query=${q}`);
        const data = await res.json();
        const container = document.getElementById('resultados');
        container.innerHTML = "";
        data.results.forEach(m => {
            if(!m.poster_path) return;
            const div = document.createElement('div');
            div.className = 'movie-card';
            div.innerHTML = `<img src="https://image.tmdb.org/t/p/w500${m.poster_path}"><h3>${m.title}</h3>`;
            div.onclick = () => abrirTester(m);
            container.appendChild(div);
        });
    }

    function abrirTester(m) {
        peliSeleccionada = m;
        document.getElementById('test-title').innerText = m.title;
        document.getElementById('player-box').style.display = 'flex';
    }

    function conectarFAPlus(tipo) {
        const status = document.getElementById('test-status');
        const video = document.getElementById('video-tester');
        status.innerText = `Conectando a ${tipo}... solicitando llave dinámica`;

        // REPLICACIÓN DEL TOKEN DE TUS CAPTURAS
        // Usamos el ID de TMDB para apuntar al servidor de Edgeon
        const id = peliSeleccionada.id;
        const time = Math.floor(Date.now() / 1000);
        
        // Esta es la estructura que vimos en tu tráfico de red
        let streamURL = (tipo === 'Ultra') 
            ? `https://cdn-llbaa8r4vvm8ea9r.edgeon-bandwidth.com/engine/hls2-c/01/${id}/master.m3u8?t=YzjdJR77qTHt_ZnSjyo9eN9q&s=${time}&e=14400`
            : `https://x8oi6owwkjoewr.premilkyway.com/engine/hls2-c/01/${id}/master.m3u8`;

        if (Hls.isSupported()) {
            const hls = new Hls({
                xhrSetup: function(xhr) {
                    // Engañamos al servidor con el Referer de FA Plus
                    xhr.setRequestHeader('Referer', 'https://ghbrisk.com/');
                }
            });
            hls.loadSource(streamURL);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                status.innerText = "¡CONEXIÓN EXITOSA! Reproduciendo Latino...";
                video.play();
            });
            hls.on(Hls.Events.ERROR, () => {
                status.innerText = "Error: Token Rechazado. Reintentando con Pegasus...";
                status.style.color = "red";
            });
        }
    }

    function cerrarPlayer() {
        const video = document.getElementById('video-tester');
        video.pause();
        video.src = "";
        document.getElementById('player-box').style.display = 'none';
    }
</script>
</body>
</html>
